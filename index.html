/**
 * RED Dashboard Application
 * Manages leaderboard display, sorting, filtering, and sparkline charts
 */

class REDDashboard {
    constructor() {
        this.leaderboardData = [];
        this.historyData = {};
        this.currentSort = { field: 'rank', direction: 'asc' };
        this.searchTerm = '';
        this.init();
    }

    async init() {
        this.setupEventListeners();
        await this.loadData();
    }

    setupEventListeners() {
        // Search box
        const searchBox = document.getElementById('searchBox');
        if (searchBox) {
            searchBox.addEventListener('input', (e) => this.handleSearch(e));
        }

        // Sort headers
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', (e) => this.handleSort(e));
        });

        // Methodology modal
        const methodologyBtn = document.getElementById('methodologyBtn');
        const methodologyModal = document.getElementById('methodologyModal');
        const closeModal = document.getElementById('closeModal');

        if (methodologyBtn && methodologyModal) {
            methodologyBtn.addEventListener('click', () => {
                methodologyModal.classList.remove('hidden');
            });
        }

        if (closeModal && methodologyModal) {
            closeModal.addEventListener('click', () => {
                methodologyModal.classList.add('hidden');
            });
        }

        // Close modal on background click
        if (methodologyModal) {
            methodologyModal.addEventListener('click', (e) => {
                if (e.target === methodologyModal) {
                    methodologyModal.classList.add('hidden');
                }
            });
        }
    }

    async loadData() {
        try {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const tableContainer = document.getElementById('tableContainer');

            // Load both datasets
            const [leaderboard, history] = await Promise.all([
                this.fetchJSON('leaderboard.json'),
                this.fetchJSON('history.json')
            ]);

            this.leaderboardData = leaderboard.teams || [];
            this.historyData = history || {};

            // Update last updated time
            if (leaderboard.generated_at) {
                this.updateLastUpdatedTime(leaderboard.generated_at);
            }

            // Hide loading, show table
            if (loadingState) loadingState.classList.add('hidden');
            if (errorState) errorState.classList.add('hidden');
            if (tableContainer) tableContainer.classList.remove('hidden');

            this.renderTable();
        } catch (error) {
            console.error('Failed to load data:', error);
            this.showError(error.message);
        }
    }

    async fetchJSON(filename) {
        const response = await fetch(`${filename}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch ${filename}: ${response.statusText}`);
        }
        return response.json();
    }

    updateLastUpdatedTime(isoTimestamp) {
        const updateTimeEl = document.getElementById('lastUpdated');
        if (updateTimeEl) {
            const date = new Date(isoTimestamp);
            const timeStr = date.toLocaleString(undefined, {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            updateTimeEl.textContent = timeStr;
        }
    }

    handleSearch(event) {
        this.searchTerm = event.target.value.toLowerCase();
        this.renderTable();
    }

    handleSort(event) {
        const th = event.currentTarget;
        const field = th.dataset.field;

        // Toggle direction if same field, otherwise reset to ascending
        if (this.currentSort.field === field) {
            this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.currentSort.field = field;
            this.currentSort.direction = 'asc';
        }

        // Update sort indicators
        document.querySelectorAll('th.sortable').forEach(t => {
            t.classList.remove('asc', 'desc');
            if (t.dataset.field === field) {
                t.classList.add(this.currentSort.direction);
            }
        });

        this.renderTable();
    }

    filterData() {
        let filtered = [...this.leaderboardData];

        if (this.searchTerm) {
            filtered = filtered.filter(team =>
                team.team.toLowerCase().includes(this.searchTerm) ||
                team.coach.toLowerCase().includes(this.searchTerm)
            );
        }

        // Sort
        filtered.sort((a, b) => {
            let aVal = a[this.currentSort.field];
            let bVal = b[this.currentSort.field];

            // Handle numeric sorting
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return this.currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle string sorting
            aVal = String(aVal).toLowerCase();
            bVal = String(bVal).toLowerCase();
            const comparison = aVal.localeCompare(bVal);
            return this.currentSort.direction === 'asc' ? comparison : -comparison;
        });

        return filtered;
    }

    renderTable() {
        const tbody = document.getElementById('tableBody');
        if (!tbody) return;

        tbody.innerHTML = '';
        const filtered = this.filterData();

        filtered.forEach(team => {
            const row = this.createTableRow(team);
            tbody.appendChild(row);
        });

        // Show no results message if needed
        if (filtered.length === 0 && this.searchTerm) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="10" style="text-align: center; padding: 20px; color: var(--text-secondary);">No teams found</td>';
            tbody.appendChild(tr);
        }
    }

    createTableRow(team) {
        const tr = document.createElement('tr');

        // Rank
        const rankTd = document.createElement('td');
        rankTd.innerHTML = `<div class="rank-badge">${team.rank}</div>`;

        // Team
        const teamTd = document.createElement('td');
        const teamLogoColor = this.getTeamColor(team.team);
        teamTd.innerHTML = `
            <div class="team-cell">
                <div class="team-logo" style="background-color: ${teamLogoColor};">
                    ${this.getTeamAbbr(team.team)}
                </div>
                <span class="team-name">${team.team}</span>
            </div>
        `;

        // Coach
        const coachTd = document.createElement('td');
        coachTd.textContent = team.coach;

        // RED Score
        const redScoreTd = document.createElement('td');
        const redScoreClass = this.getREDScoreClass(team.red_score);
        redScoreTd.innerHTML = `<div class="red-score ${redScoreClass}">${team.red_score.toFixed(2)}</div>`;

        // RED Per Game
        const redPerGameTd = document.createElement('td');
        redPerGameTd.textContent = team.red_per_game.toFixed(4);

        // Record
        const recordTd = document.createElement('td');
        recordTd.textContent = `${team.actual_wins}-${team.games_played - team.actual_wins}`;

        // Expected Wins
        const expectedTd = document.createElement('td');
        expectedTd.textContent = team.expected_wins.toFixed(1);

        // Games Played
        const gpTd = document.createElement('td');
        gpTd.textContent = team.games_played;

        // Trend
        const trendTd = document.createElement('td');
        const trendNum = parseFloat(team.trend);
        const trendClass = trendNum > 0 ? 'up' : trendNum < 0 ? 'down' : 'neutral';
        const trendSymbol = trendNum > 0 ? '‚ñ≤' : trendNum < 0 ? '‚ñº' : '‚Äî';
        trendTd.innerHTML = `<div class="trend-badge ${trendClass}">${trendSymbol} ${team.trend}</div>`;

        // Chart (Sparkline)
        const chartTd = document.createElement('td');
        const canvas = document.createElement('canvas');
        canvas.className = 'sparkline';
        canvas.width = 80;
        canvas.height = 30;
        chartTd.appendChild(canvas);

        // Draw sparkline
        this.drawSparkline(canvas, team.team);

        tr.appendChild(rankTd);
        tr.appendChild(teamTd);
        tr.appendChild(coachTd);
        tr.appendChild(redScoreTd);
        tr.appendChild(redPerGameTd);
        tr.appendChild(recordTd);
        tr.appendChild(expectedTd);
        tr.appendChild(gpTd);
        tr.appendChild(trendTd);
        tr.appendChild(chartTd);

        return tr;
    }

    getREDScoreClass(score) {
        if (score > 1.5) return 'strong-positive';
        if (score > 0.5) return 'positive';
        if (score > -0.5) return 'neutral';
        if (score > -1.5) return 'warning';
        return 'danger';
    }

    getTeamColor(teamName) {
        // NBA team colors mapping
        const colors = {
            'Atlanta Hawks': '#E03C28',
            'Boston Celtics': '#007A33',
            'Brooklyn Nets': '#000000',
            'Charlotte Hornets': '#1D1160',
            'Chicago Bulls': '#CE1141',
            'Cleveland Cavaliers': '#6F2DA8',
            'Dallas Mavericks': '#00538C',
            'Denver Nuggets': '#0E2240',
            'Detroit Pistons': '#C41E3A',
            'Golden State Warriors': '#1D428A',
            'Houston Rockets': '#CE1141',
            'Indiana Pacers': '#002D62',
            'Los Angeles Clippers': '#C4CED4',
            'Los Angeles Lakers': '#552583',
            'Memphis Grizzlies': '#12173F',
            'Miami Heat': '#98002E',
            'Milwaukee Bucks': '#12173F',
            'Minnesota Timberwolves': '#0C2340',
            'New Orleans Pelicans': '#0C2340',
            'New York Knicks': '#F58426',
            'Oklahoma City Thunder': '#007DC3',
            'Orlando Magic': '#0077B6',
            'Philadelphia 76ers': '#1D1160',
            'Phoenix Suns': '#E56020',
            'Portland Trail Blazers': '#E03C28',
            'Sacramento Kings': '#5A2D81',
            'San Antonio Spurs': '#B6B6B6',
            'Toronto Raptors': '#CE1141',
            'Utah Jazz': '#002B5C',
            'Washington Wizards': '#002B5C',
        };
        return colors[teamName] || '#C9A84C';
    }

    getTeamAbbr(teamName) {
        const abbrs = {
            'Atlanta Hawks': 'ATL',
            'Boston Celtics': 'BOS',
            'Brooklyn Nets': 'BRK',
            'Charlotte Hornets': 'CHA',
            'Chicago Bulls': 'CHI',
            'Cleveland Cavaliers': 'CLE',
            'Dallas Mavericks': 'DAL',
            'Denver Nuggets': 'DEN',
            'Detroit Pistons': 'DET',
            'Golden State Warriors': 'GSW',
            'Houston Rockets': 'HOU',
            'Indiana Pacers': 'IND',
            'Los Angeles Clippers': 'LAC',
            'Los Angeles Lakers': 'LAL',
            'Memphis Grizzlies': 'MEM',
            'Miami Heat': 'MIA',
            'Milwaukee Bucks': 'MIL',
            'Minnesota Timberwolves': 'MIN',
            'New Orleans Pelicans': 'NOP',
            'New York Knicks': 'NYK',
            'Oklahoma City Thunder': 'OKC',
            'Orlando Magic': 'ORL',
            'Philadelphia 76ers': 'PHI',
            'Phoenix Suns': 'PHX',
            'Portland Trail Blazers': 'POR',
            'Sacramento Kings': 'SAC',
            'San Antonio Spurs': 'SAS',
            'Toronto Raptors': 'TOR',
            'Utah Jazz': 'UTA',
            'Washington Wizards': 'WAS',
        };
        return abbrs[teamName] || '?';
    }

    drawSparkline(canvas, teamName) {
        const ctx = canvas.getContext('2d');
        const data = this.historyData[teamName] || [];

        if (data.length === 0) {
            // Draw placeholder
            ctx.fillStyle = '#6b7280';
            ctx.font = '10px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('No data', canvas.width / 2, canvas.height / 2);
            return;
        }

        // Get min/max for scaling
        const scores = data.map(d => d.red_score);
        const minScore = Math.min(...scores);
        const maxScore = Math.max(...scores);
        const range = maxScore - minScore || 1;

        // Draw background
        ctx.fillStyle = 'rgba(201, 168, 76, 0.03)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw zero line
        const zeroY = canvas.height * (maxScore / (maxScore - minScore + 0.0001));
        ctx.strokeStyle = 'rgba(201, 168, 76, 0.2)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, zeroY);
        ctx.lineTo(canvas.width, zeroY);
        ctx.stroke();

        // Draw line chart
        ctx.strokeStyle = '#C9A84C';
        ctx.lineWidth = 2;
        ctx.beginPath();

        data.forEach((point, i) => {
            const x = (i / (data.length - 1 || 1)) * canvas.width;
            const y = canvas.height * (1 - (point.red_score - minScore) / range);

            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });

        ctx.stroke();

        // Draw points
        ctx.fillStyle = '#C9A84C';
        data.forEach((point, i) => {
            const x = (i / (data.length - 1 || 1)) * canvas.width;
            const y = canvas.height * (1 - (point.red_score - minScore) / range);
            ctx.beginPath();
            ctx.arc(x, y, 2, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    showError(message) {
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const loadingState = document.getElementById('loadingState');
        const tableContainer = document.getElementById('tableContainer');

        if (loadingState) loadingState.classList.add('hidden');
        if (tableContainer) tableContainer.classList.add('hidden');

        if (errorState && errorMessage) {
            errorMessage.textContent = message;
            errorState.classList.remove('hidden');
        }
    }
}

// Initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new REDDashboard();
});

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>RED ‚Äî 2025‚Äì26 Live Season</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:       #0A0C12;
  --surface:  #11141E;
  --s2:       #161A28;
  --border:   #222840;
  --border2:  #2E3454;
  --text:     #E2E8F4;
  --muted:    #6B7A9C;
  --silver:   #9BAAC0;
  --chrome:   #C4D0E4;
  --gold:     #C9A84C;
  --gold-bg:  rgba(201,168,76,0.10);
  --pos:      #4ADE80;
  --pos-bg:   rgba(74,222,128,0.10);
  --pos2:     #F4CF59;
  --pos2-bg:  rgba(244,207,89,0.10);
  --neu:      #9BAAC0;
  --neu-bg:   rgba(155,170,192,0.08);
  --neg2:     #FB923C;
  --neg2-bg:  rgba(251,146,60,0.10);
  --neg:      #F87171;
  --neg-bg:   rgba(248,113,113,0.10);
}
html { scroll-behavior: smooth; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--silver); }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 0 2rem; position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 20px rgba(0,0,0,0.4);
}
.header-inner {
  max-width: 1400px; margin: 0 auto;
  display: flex; align-items: center; justify-content: space-between;
  gap: 1.5rem; flex-wrap: wrap; padding: 0.9rem 0;
}
.logo { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; color: var(--gold); letter-spacing: 5px; line-height: 1; }
.logo-sub { font-size: 0.65rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; }
.header-right { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
.live-badge {
  display: flex; align-items: center; gap: 6px;
  background: rgba(74,222,128,0.08); border: 1px solid rgba(74,222,128,0.25);
  color: var(--pos); font-size: 0.72rem; font-weight: 600; letter-spacing: 0.5px;
  padding: 4px 12px; border-radius: 20px;
}
.live-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--pos); animation: pulse 1.8s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.8)} }
.header-search {
  font-family: 'Inter', sans-serif; background: var(--bg);
  border: 1px solid var(--border2); color: var(--text);
  padding: 7px 14px; border-radius: 8px; font-size: 0.84rem;
  width: 230px; outline: none; transition: border-color 0.15s, box-shadow 0.15s;
}
.header-search:focus { border-color: var(--silver); box-shadow: 0 0 0 2px rgba(155,170,192,0.15); }
.header-search::placeholder { color: var(--muted); }
.help-btn {
  background: transparent; border: 1px solid var(--border2); color: var(--muted);
  width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
  font-size: 0.85rem; font-weight: 700; font-family: 'Inter', sans-serif;
  transition: all 0.15s; display: flex; align-items: center; justify-content: center;
}
.help-btn:hover { border-color: var(--silver); color: var(--chrome); }

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav {
  background: var(--s2); border-bottom: 1px solid var(--border);
  padding: 0 2rem; overflow-x: auto;
}
.nav-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; }
.nav-label { font-size: 0.65rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; white-space: nowrap; padding: 10px 14px 10px 0; border-right: 1px solid var(--border); margin-right: 4px; }
.nav-link { display: inline-block; padding: 10px 16px; font-size: 0.82rem; font-weight: 500; color: var(--muted); text-decoration: none; border-bottom: 2px solid transparent; white-space: nowrap; transition: all 0.15s; }
.nav-link:hover { color: var(--chrome); border-bottom-color: var(--silver); }
.nav-link.active { color: var(--gold); border-bottom-color: var(--gold); font-weight: 600; }
.nav-spacer { flex: 1; }

/* ‚îÄ‚îÄ META BAR ‚îÄ‚îÄ */
.meta-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.45rem 2rem; }
.meta-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
.meta-stat { font-size: 0.74rem; color: var(--muted); }
.meta-stat strong { color: var(--chrome); font-weight: 600; }
#dataTimestamp { font-size: 0.72rem; color: var(--muted); font-style: italic; }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.container { max-width: 1400px; margin: 0 auto; padding: 1.5rem 2rem 4rem; }

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 380px; gap: 1.5rem; }
.spinner { width: 44px; height: 44px; border: 3px solid var(--border2); border-top: 3px solid var(--silver); border-radius: 50%; animation: spin 0.9s linear infinite; }
@keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
.progress-text { color: var(--muted); font-size: 0.85rem; }

/* ‚îÄ‚îÄ RESULTS HEADER ‚îÄ‚îÄ */
.results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.8rem; }
.results-info { font-size: 0.82rem; color: var(--muted); }
.results-info strong { color: var(--chrome); }
.refresh-btn {
  background: transparent; color: var(--muted); border: 1px solid var(--border2);
  padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;
  font-family: 'Inter', sans-serif; transition: all 0.15s;
}
.refresh-btn:hover { border-color: var(--silver); color: var(--chrome); }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden; overflow-x: auto;
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
}
table { width: 100%; border-collapse: collapse; min-width: 680px; }
thead { background: var(--bg); }
th {
  padding: 10px 16px; text-align: left; font-size: 0.66rem; font-weight: 700;
  letter-spacing: 1.4px; color: var(--muted); text-transform: uppercase;
  border-bottom: 1px solid var(--border2); white-space: nowrap;
  cursor: pointer; user-select: none; transition: color 0.15s;
}
th:hover { color: var(--chrome); }
th.sorted { color: var(--silver); }
td { padding: 11px 16px; font-size: 0.87rem; border-bottom: 1px solid var(--border); vertical-align: middle; white-space: nowrap; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--s2); }
.rank-cell { font-weight: 700; color: var(--muted); font-size: 0.84rem; width: 46px; }
.rank-medal { margin-right: 3px; }

/* ‚îÄ‚îÄ TEAM CIRCLE ‚îÄ‚îÄ */
.team-badge { display: flex; align-items: center; gap: 10px; }
.team-circle {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.68rem; color: #fff; flex-shrink: 0;
  letter-spacing: 0.3px; opacity: 0.92;
}
.team-name { font-weight: 600; font-size: 0.9rem; color: var(--chrome); }
.coach-cell { font-size: 0.82rem; color: var(--muted); }
.record-cell { font-family: monospace; font-size: 0.84rem; color: var(--muted); font-weight: 600; }
.stats-cell { font-family: monospace; font-size: 0.81rem; color: var(--muted); }

/* ‚îÄ‚îÄ RED BADGE ‚îÄ‚îÄ */
.red-score {
  display: inline-block; font-weight: 700; font-size: 0.92rem;
  font-family: monospace; padding: 3px 10px; border-radius: 5px;
  min-width: 72px; text-align: center; letter-spacing: 0.3px;
}
.red-score.excellent { background: var(--pos-bg);  color: var(--pos); }
.red-score.good      { background: var(--pos2-bg); color: var(--pos2); }
.red-score.neutral   { background: var(--neu-bg);  color: var(--neu); }
.red-score.poor      { background: var(--neg2-bg); color: var(--neg2); }
.red-score.bad       { background: var(--neg-bg);  color: var(--neg); }

/* ‚îÄ‚îÄ NO DATA ‚îÄ‚îÄ */
.no-data { text-align: center; padding: 3rem; color: var(--muted); font-size: 0.9rem; }

/* ‚îÄ‚îÄ FORMULA NOTE ‚îÄ‚îÄ */
.formula-note {
  margin-top: 1.5rem; padding: 1.1rem 1.5rem;
  background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--gold);
  border-radius: 8px; font-size: 0.79rem; color: var(--muted); line-height: 1.8;
}
.formula-note strong { color: var(--chrome); }
.fc { font-family: monospace; background: var(--bg); padding: 2px 8px; border-radius: 4px; color: var(--gold); }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.7); animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.modal-content {
  background: var(--surface); margin: 5% auto; padding: 2rem;
  border: 1px solid var(--border2); border-radius: 10px;
  width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
  box-shadow: 0 12px 40px rgba(0,0,0,0.6); animation: slideIn 0.25s ease;
}
@keyframes slideIn { from{transform:translateY(-30px);opacity:0} to{transform:translateY(0);opacity:1} }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border2); padding-bottom: 1rem; }
.modal-header h2 { color: var(--chrome); font-size: 1.3rem; font-weight: 600; margin: 0; }
.close-btn { color: var(--muted); font-size: 1.6rem; font-weight: 300; cursor: pointer; background: none; border: none; line-height: 1; transition: color 0.15s; }
.close-btn:hover { color: var(--chrome); }
.modal-body { color: var(--text); line-height: 1.8; font-size: 0.88rem; }
.modal-body h3 { color: var(--silver); font-size: 0.85rem; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; margin: 1.4rem 0 0.5rem; }
.modal-body p { margin-bottom: 0.9rem; color: var(--muted); }
.modal-body strong { color: var(--text); }
.formula-box {
  background: var(--bg); border-left: 3px solid var(--gold);
  padding: 0.9rem 1.1rem; margin: 0.8rem 0; border-radius: 4px;
  font-family: 'Courier New', monospace; font-size: 0.82rem; color: #86d57d;
  overflow-x: auto; line-height: 1.7;
}
.modal-body ul { margin-left: 1.4rem; margin-bottom: 1rem; color: var(--muted); }
.modal-body li { margin-bottom: 0.3rem; }

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media (max-width: 768px) {
  header { padding: 0 1rem; }
  .logo { font-size: 1.6rem; }
  .header-search { width: 100%; }
  .header-right { width: 100%; gap: 0.6rem; }
  nav { padding: 0 0.5rem; }
  .nav-link { padding: 8px 11px; font-size: 0.75rem; }
  .meta-bar { padding: 0.4rem 1rem; }
  .container { padding: 1rem 1rem 3rem; }
  th { padding: 8px 10px; font-size: 0.6rem; }
  td { padding: 9px 10px; font-size: 0.83rem; }
  .red-score { min-width: 60px; font-size: 0.85rem; padding: 2px 7px; }
  table { min-width: 580px; }
  .team-circle { width: 30px; height: 30px; font-size: 0.6rem; }
}
@media (max-width: 480px) {
  .logo { font-size: 1.4rem; }
  th, td { padding: 7px 8px; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div>
      <div class="logo">RED</div>
      <div class="logo-sub">Rating of Elite Dominance</div>
    </div>
    <div class="header-right">
      <div class="live-badge"><span class="live-dot"></span>2025‚Äì26 Live</div>
      <input type="text" class="header-search" id="searchBox" placeholder="Search team or coach‚Ä¶">
      <button class="help-btn" id="helpBtn" title="How RED is calculated">?</button>
    </div>
  </div>
</header>

<nav>
  <div class="nav-inner">
    <span class="nav-label">RED System</span>
    <a href="https://redcoachingstat.github.io/1/" class="nav-link active">2025‚Äì26 Live</a>
    <a href="https://redcoachingstat.github.io/1/All/" class="nav-link">All Seasons (1975‚Äì76 ‚Üí present) &#8594;</a>
    <span class="nav-spacer"></span>
  </div>
</nav>

<div class="meta-bar">
  <div class="meta-inner">
    <div class="meta-stat">
      <strong id="teamCount">‚Äî</strong> teams ¬∑ 2025‚Äì26 season
    </div>
    <div id="dataTimestamp">Loading‚Ä¶</div>
  </div>
</div>

<div class="container">
  <div id="loadingContainer" class="loading-container">
    <div class="spinner"></div>
    <p class="progress-text">Fetching live standings‚Ä¶</p>
    <p class="progress-text" id="progressText"></p>
  </div>

  <div id="resultsContainer" style="display:none;">
    <div class="results-header">
      <div class="results-info">
        Sorted by RED Score &nbsp;¬∑&nbsp; click any column to re-sort
      </div>
      <div>
        <span id="nextRefreshLabel" style="display:none;"></span>
        <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">‚ü≥ Refresh</button>
      </div>
    </div>
    <div class="table-card">
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th class="sortable" data-sort="rank">Rank</th>
            <th class="sortable" data-sort="team">Team</th>
            <th class="sortable" data-sort="coach">Coach</th>
            <th class="sortable" data-sort="red">RED Score</th>
            <th class="sortable" data-sort="red-per-game">RED/G</th>
            <th class="sortable" data-sort="record">Record</th>
            <th class="sortable" data-sort="games">GP</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
    <div id="noDataMessage" class="no-data" style="display:none;">No teams match your search.</div>

    <div class="formula-note">
      <strong>RED Formula:</strong>
      <span class="fc">RED = 0.70 √ó WinsAbove.500 + 0.30 √ó PythagoreanDelta</span>
      &nbsp;¬∑&nbsp; Descriptive only ‚Äî not predictive.
      &nbsp;¬∑&nbsp; Data via ESPN API (auto-refreshes every 20 min).
    </div>
  </div>
</div>

<div id="helpModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>How RED Works</h2>
      <button class="close-btn" id="closeModalBtn">&times;</button>
    </div>
    <div class="modal-body">
      <p><strong>RED (Rating of Elite Dominance)</strong> is a team season performance metric. It measures how dominant a team truly is ‚Äî combining their record relative to league-average with how efficiently they convert scoring margin into wins.</p>
      <h3>The Core Idea</h3>
      <p>Every team has a "true" performance level hidden in their scoring margins. RED captures the gap between actual wins and what point differential predicts. This makes RED era-neutral ‚Äî so you can compare the 2025‚Äì26 Spurs to the 1975‚Äì76 Warriors on the same scale.</p>
      <h3>The Formula</h3>
      <div class="formula-box">(A) Quality = Actual Wins ‚àí (GP √ó 0.5)
    ‚Üí Wins above league-average pace

(B) Efficiency = Actual Wins ‚àí Pythagorean Expected Wins
    Pythagorean Win% = PtsFor¬π¬≥¬∑‚Åπ¬π √∑ (PtsFor¬π¬≥¬∑‚Åπ¬π + PtsAgainst¬π¬≥¬∑‚Åπ¬π)
    ‚Üí Winning more than scoring margin predicts?

RED = (0.70 √ó Quality) + (0.30 √ó Efficiency)</div>
      <h3>Interpretation</h3>
      <p><strong>Positive RED:</strong> Winning above pace and/or converting margin efficiently. Truly dominant teams score highest.</p>
      <p><strong>Negative RED:</strong> Below .500 pace and/or underperforming point differential.</p>
      <p><strong>The efficiency signal (30%):</strong> Rewards teams squeezing extra wins beyond what raw scoring predicts ‚Äî defense-first teams, clutch units.</p>
      <h3>Notes</h3>
      <ul>
        <li>RED is <strong>descriptive</strong> ‚Äî what happened, not what will happen</li>
        <li>Uses live ESPN standings data; falls back to All-Star break snapshot</li>
        <li>Compare against all historical seasons at <a href="https://redcoachingstat.github.io/1/All/" style="color:var(--gold)">All Seasons</a></li>
      </ul>
    </div>
  </div>
</div>

<script>

        // Static Data
        // No preseason data needed. RED is now 100% based on current season performance.

        const ESPN_TEAMS = [
            { id: "1",  name: "Atlanta Hawks",          abbr: "ATL", coach: "Quin Snyder", color: "#E03C21" },
            { id: "2",  name: "Boston Celtics",         abbr: "BOS", coach: "Joe Mazzulla", color: "#007A33" },
            { id: "17", name: "Brooklyn Nets",          abbr: "BKN", coach: "Jordi Fernandez", color: "#000000" },
            { id: "30", name: "Charlotte Hornets",      abbr: "CHA", coach: "Charles Lee", color: "#00778D" },
            { id: "4",  name: "Chicago Bulls",          abbr: "CHI", coach: "Billy Donovan", color: "#CE1141" },
            { id: "5",  name: "Cleveland Cavaliers",    abbr: "CLE", coach: "Kenny Atkinson", color: "#6F2DA8" },
            { id: "6",  name: "Dallas Mavericks",       abbr: "DAL", coach: "Jason Kidd", color: "#002B81" },
            { id: "7",  name: "Denver Nuggets",         abbr: "DEN", coach: "David Adelman", color: "#0E2240" },
            { id: "8",  name: "Detroit Pistons",        abbr: "DET", coach: "J.B. Bickerstaff", color: "#C8102E" },
            { id: "9",  name: "Golden State Warriors",  abbr: "GSW", coach: "Steve Kerr", color: "#1D428A" },
            { id: "10", name: "Houston Rockets",        abbr: "HOU", coach: "Ime Udoka", color: "#CE1141" },
            { id: "11", name: "Indiana Pacers",         abbr: "IND", coach: "Rick Carlisle", color: "#002D58" },
            { id: "12", name: "Los Angeles Clippers",   abbr: "LAC", coach: "Tyronn Lue", color: "#C60C30" },
            { id: "13", name: "Los Angeles Lakers",     abbr: "LAL", coach: "JJ Redick", color: "#552583" },
            { id: "29", name: "Memphis Grizzlies",      abbr: "MEM", coach: "Tuomas Iisalo", color: "#12173F" },
            { id: "14", name: "Miami Heat",             abbr: "MIA", coach: "Erik Spoelstra", color: "#98002E" },
            { id: "15", name: "Milwaukee Bucks",        abbr: "MIL", coach: "Doc Rivers", color: "#12173F" },
            { id: "16", name: "Minnesota Timberwolves", abbr: "MIN", coach: "Chris Finch", color: "#0C2B4C" },
            { id: "3",  name: "New Orleans Pelicans",   abbr: "NOP", coach: "James Borrego (interim)", color: "#0C2340" },
            { id: "18", name: "New York Knicks",        abbr: "NYK", coach: "Mike Brown", color: "#F58426" },
            { id: "25", name: "Oklahoma City Thunder",  abbr: "OKC", coach: "Mark Daigneault", color: "#007AC1" },
            { id: "19", name: "Orlando Magic",          abbr: "ORL", coach: "Jamahl Mosley", color: "#0077B6" },
            { id: "20", name: "Philadelphia 76ers",     abbr: "PHI", coach: "Nick Nurse", color: "#1D1160" },
            { id: "21", name: "Phoenix Suns",           abbr: "PHX", coach: "Jordan Ott", color: "#1D1160" },
            { id: "22", name: "Portland Trail Blazers", abbr: "POR", coach: "Chauncey Billups", color: "#E03C21" },
            { id: "23", name: "Sacramento Kings",       abbr: "SAC", coach: "Doug Christie", color: "#5A2D81" },
            { id: "24", name: "San Antonio Spurs",      abbr: "SAS", coach: "Mitch Johnson", color: "#C4CED4" },
            { id: "28", name: "Toronto Raptors",        abbr: "TOR", coach: "Darko Rajakovic", color: "#CE1141" },
            { id: "26", name: "Utah Jazz",              abbr: "UTA", coach: "Will Hardy", color: "#002B5C" },
            { id: "27", name: "Washington Wizards",     abbr: "WAS", coach: "Brian Keefe", color: "#002B5C" }
        ];

        // ‚îÄ‚îÄ Preseason Expected Wins (2025-26 Vegas consensus / media projections) ‚îÄ‚îÄ
        // These represent what each team was projected to win BEFORE the season started,
        // based on preseason odds & roster assessment. This is the "roster quality" baseline.
        // Beating this = coach is outperforming their talent level.
        // Note: Boston's 54W projection assumes a healthy Jayson Tatum. His Achilles injury
        // means Mazzulla's 37-19 is a dramatic overperformance of adjusted expectations.
        // DOM Elements
        const loadingContainer = document.getElementById('loadingContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const searchBox = document.getElementById('searchBox');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const progressText = document.getElementById('progressText');
        const noDataMessage = document.getElementById('noDataMessage');
        const dataTimestamp = document.getElementById('dataTimestamp');
        const teamCount = document.getElementById('teamCount');

        let allResults = [];
        let currentSort = { column: 'red', direction: 'desc' };

        // Helper Functions
        function formatDate(date) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${now.getFullYear()}-${month}-${day} ${hours}:${minutes} UTC`;
        }

        // ‚îÄ‚îÄ Fallback standings (~Feb 22, 2026) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // W-L: sourced from confirmed public reporting (power rankings, game logs).
        // Key confirmed: OKC 44-14, SAS 40-16, DET ~40-15, BOS 37-19,
        //   NYK 37-21, HOU 35-21, TOR 34-21, PHX 33-25, SAC 13-46.
        // PPG / OPPG: estimated from team style + confirmed point differentials.
        const FALLBACK_RECORDS = {
            // Team                              W    L      PF      PA
            "Oklahoma City Thunder":  { wins: 44, losses: 14, ptsFor: 118.8, ptsAgainst: 107.4 },
            "San Antonio Spurs":      { wins: 40, losses: 16, ptsFor: 118.2, ptsAgainst: 108.8 },
            "Detroit Pistons":        { wins: 40, losses: 15, ptsFor: 113.2, ptsAgainst: 103.8 },
            "Boston Celtics":         { wins: 37, losses: 19, ptsFor: 119.8, ptsAgainst: 111.6 },
            "New York Knicks":        { wins: 37, losses: 21, ptsFor: 115.2, ptsAgainst: 109.8 },
            "Cleveland Cavaliers":    { wins: 36, losses: 22, ptsFor: 116.4, ptsAgainst: 111.8 },
            "Houston Rockets":        { wins: 35, losses: 21, ptsFor: 117.1, ptsAgainst: 112.2 },
            "Toronto Raptors":        { wins: 34, losses: 21, ptsFor: 114.6, ptsAgainst: 110.4 },
            "Phoenix Suns":           { wins: 33, losses: 25, ptsFor: 114.8, ptsAgainst: 112.4 },
            "Los Angeles Clippers":   { wins: 32, losses: 25, ptsFor: 113.6, ptsAgainst: 111.8 },
            "Denver Nuggets":         { wins: 31, losses: 26, ptsFor: 116.2, ptsAgainst: 113.8 },
            "Los Angeles Lakers":     { wins: 30, losses: 27, ptsFor: 115.8, ptsAgainst: 114.4 },
            "Minnesota Timberwolves": { wins: 29, losses: 28, ptsFor: 113.2, ptsAgainst: 112.6 },
            "Golden State Warriors":  { wins: 29, losses: 28, ptsFor: 116.8, ptsAgainst: 116.2 },
            "Dallas Mavericks":       { wins: 28, losses: 29, ptsFor: 113.4, ptsAgainst: 114.8 },
            "Milwaukee Bucks":        { wins: 27, losses: 30, ptsFor: 114.2, ptsAgainst: 115.8 },
            "Memphis Grizzlies":      { wins: 26, losses: 31, ptsFor: 114.8, ptsAgainst: 116.5 },
            "Miami Heat":             { wins: 25, losses: 32, ptsFor: 111.8, ptsAgainst: 113.9 },
            "Orlando Magic":          { wins: 25, losses: 32, ptsFor: 109.6, ptsAgainst: 111.8 },
            "Philadelphia 76ers":     { wins: 24, losses: 33, ptsFor: 112.1, ptsAgainst: 115.4 },
            "New Orleans Pelicans":   { wins: 22, losses: 35, ptsFor: 110.8, ptsAgainst: 115.2 },
            "Atlanta Hawks":          { wins: 21, losses: 36, ptsFor: 114.4, ptsAgainst: 118.6 },
            "Charlotte Hornets":      { wins: 18, losses: 39, ptsFor: 111.4, ptsAgainst: 118.2 },
            "Chicago Bulls":          { wins: 18, losses: 39, ptsFor: 110.6, ptsAgainst: 117.8 },
            "Indiana Pacers":         { wins: 16, losses: 41, ptsFor: 118.2, ptsAgainst: 124.6 },
            "Brooklyn Nets":          { wins: 16, losses: 41, ptsFor: 108.8, ptsAgainst: 118.2 },
            "Portland Trail Blazers": { wins: 15, losses: 42, ptsFor: 108.6, ptsAgainst: 117.6 },
            "Utah Jazz":              { wins: 13, losses: 44, ptsFor: 107.9, ptsAgainst: 120.1 },
            "Sacramento Kings":       { wins: 13, losses: 46, ptsFor: 107.6, ptsAgainst: 121.8 },
            "Washington Wizards":     { wins: 10, losses: 47, ptsFor: 105.8, ptsAgainst: 122.4 },
        };

        // ‚îÄ‚îÄ Single-call ESPN standings fetch (all 30 teams, one request) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function fetchAllStandings() {
            const url = 'https://site.api.espn.com/apis/v2/sports/basketball/nba/standings?season=2026';
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                const entries = data?.standings?.entries || [];
                if (entries.length < 28) throw new Error('Incomplete standings data');

                const records = {};
                for (const entry of entries) {
                    const name = entry.team?.displayName;
                    if (!name) continue;
                    const stats = entry.stats || [];

                    // Helper: find a stat by any of several possible field names ESPN uses
                    const get = (...keys) => {
                        for (const key of keys) {
                            const s = stats.find(s => s.name === key || s.abbreviation === key || s.shortDisplayName === key);
                            if (s) return parseFloat(s.value) || 0;
                        }
                        return 0;
                    };

                    const wins     = Math.round(get('wins',   'W'));
                    const losses   = Math.round(get('losses', 'L'));
                    // ESPN may expose avg points as 'pointsFor'/'pointsAgainst' or 'avgPoints'/'oppAvgPoints'
                    const ptsFor   = get('pointsFor', 'avgPoints',    'ppg',  'Points For');
                    const ptsAgainst = get('pointsAgainst', 'oppAvgPoints', 'oppg', 'Points Against');

                    records[name] = { wins, losses, ptsFor, ptsAgainst };
                }

                // If ESPN didn't return points data, pull it from our fallback
                for (const [team, rec] of Object.entries(records)) {
                    if (!rec.ptsFor && FALLBACK_RECORDS[team]) {
                        rec.ptsFor     = FALLBACK_RECORDS[team].ptsFor;
                        rec.ptsAgainst = FALLBACK_RECORDS[team].ptsAgainst;
                    }
                }

                console.log(`‚úÖ Live standings loaded for ${Object.keys(records).length} teams`);
                return { records, source: 'live' };
            } catch (err) {
                console.warn('Live standings failed ‚Äî using All-Star break fallback:', err.message);
                return { records: FALLBACK_RECORDS, source: 'fallback' };
            }
        }

        // ‚îÄ‚îÄ RED Calculation: Hybrid Quality + Pythagorean Efficiency ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        //
        // Problem with pure Pythagorean: bad teams that get blown out but somehow
        // win a few close games score POSITIVE RED (e.g. Wizards ranked #1). That's
        // because their terrible differential predicts almost zero wins, so any
        // actual wins look like coaching genius.
        //
        // Fix: blend two components ‚Äî
        //   (A) Quality Score   ‚Äî wins above league-average pace (.500)
        //                         captures overall team performance
        //   (B) Efficiency Score ‚Äî Pythagorean delta (wins above what PPG predicts)
        //                         captures coaching edge in close games / conversions
        //
        //   RED = 0.70 √ó Quality + 0.30 √ó Efficiency
        //
        // This way good teams rank high (dominated by quality), bad teams rank low,
        // and the Pythagorean component still rewards coaches squeezing out extra
        // wins vs their talent level ‚Äî e.g. Celtics overperforming without Tatum.
        //
        // Scale: roughly -15 (worst) to +15 (best) over a full season.
        // ‚îÄ‚îÄ RED Formula ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // RED = 0.70 √ó WinsAbove.500 + 0.30 √ó PythagoreanDelta
        //
        // WinsAbove.500: actual wins minus the league-neutral .500 pace.
        //   Every win above average reflects coaching output. A neutral baseline
        //   avoids penalising top teams for being expected to be good.
        //
        // PythagoreanDelta: actual wins minus wins predicted from point differential.
        //   Measures coaching decisions ‚Äî rotations, late-game management, clutch subs.
        //   A positive delta means winning close games more than the margin predicts.
        //
        // Scale: roughly ‚Äì15 (worst) to +15 (best) over a full season.
        function calculateRED(wins, losses, ptsFor, ptsAgainst) {
            const gamesPlayed = wins + losses;
            if (gamesPlayed === 0 || ptsFor === 0 || ptsAgainst === 0) {
                return { redScore: 0, gamesPlayed: 0, actualWins: wins,
                         actualLosses: losses, expectedWins: 0, redPerGame: 0 };
            }

            // (A) Wins above .500 pace
            const winsAboveAvg = wins - (gamesPlayed * 0.5);

            // (B) Pythagorean efficiency
            const EXP          = 13.91;
            const pfPow        = Math.pow(ptsFor,     EXP);
            const paPow        = Math.pow(ptsAgainst, EXP);
            const pythWinPct   = pfPow / (pfPow + paPow);
            const expectedWins = pythWinPct * gamesPlayed;
            const pythDelta    = wins - expectedWins;

            // Blend: quality dominates, efficiency adds nuance
            const redScore   = (0.70 * winsAboveAvg) + (0.30 * pythDelta);
            const redPerGame = redScore / gamesPlayed;

            return {
                redScore,
                gamesPlayed,
                actualWins:   wins,
                actualLosses: losses,
                expectedWins: parseFloat(expectedWins.toFixed(1)),
                redPerGame
            };
        }

        async function initializeSystem() {
            allResults = [];
            progressText.textContent = 'Fetching standings...';

            // One single API call for all 30 teams ‚Äî falls back to hardcoded data if it fails
            const { records, source } = await fetchAllStandings();

            for (const team of ESPN_TEAMS) {
                const rec = records[team.name];
                if (!rec) continue;
                if ((rec.wins + rec.losses) === 0) continue;

                const redData = calculateRED(
                    rec.wins, rec.losses, rec.ptsFor, rec.ptsAgainst
                );
                allResults.push({ ...team, ...redData });
            }

            // Show data source in timestamp
            const sourceLabel = source === 'live'
                ? 'Live data via ESPN'
                : 'Standings as of All-Star Break 2026 (fallback)';

            // Sort by RED score descending
            allResults.sort((a, b) => b.redScore - a.redScore);

            // Show results
            loadingContainer.style.display = 'none';
            resultsContainer.style.display = 'block';
            dataTimestamp.textContent = `${sourceLabel} ¬∑ ${formatDate(new Date())}`;
            teamCount.textContent = allResults.length;

            renderLeaderboard(allResults);
        }

        function getRedScoreClass(score) {
            if (score > 2.0) return 'excellent';
            if (score > 0.5) return 'good';
            if (score > -0.5) return 'neutral';
            if (score > -2.0) return 'poor';
            return 'bad';
        }

        function getRankMedal(rank) {
            if (rank === 1) return 'ü•á';
            if (rank === 2) return 'ü•à';
            if (rank === 3) return 'ü•â';
            return '';
        }

        function renderLeaderboard(data) {
            leaderboardBody.innerHTML = '';
            
            if (data.length === 0) {
                noDataMessage.style.display = 'block';
                return;
            } else {
                noDataMessage.style.display = 'none';
            }

            data.forEach((result, index) => {
                const rank = index + 1;
                const row = document.createElement('tr');

                const redScoreClass = getRedScoreClass(result.redScore);
                const medal = getRankMedal(rank);
                const record = `${result.actualWins}-${result.actualLosses}`;
                const redPerGameStr = (result.redPerGame >= 0 ? '+' : '') + result.redPerGame.toFixed(3);
                const redScoreStr   = (result.redScore   >= 0 ? '+' : '') + result.redScore.toFixed(2);

                row.innerHTML = `
                    <td class="rank-cell">
                        <span class="rank-medal">${medal}</span>${rank}
                    </td>
                    <td>
                        <div class="team-badge">
                            <div class="team-circle" style="background-color: ${result.color};">
                                ${result.abbr}
                            </div>
                            <span>${result.name}</span>
                        </div>
                    </td>
                    <td>${result.coach}</td>
                    <td>
                        <div class="red-score ${redScoreClass}">
                            ${redScoreStr}
                        </div>
                    </td>
                    <td class="stats-cell">${redPerGameStr}</td>
                    <td class="record-cell">${record}</td>
                    <td class="stats-cell">${result.gamesPlayed}</td>
                `;

                leaderboardBody.appendChild(row);
            });

            attachSortListeners();
        }

        function attachSortListeners() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'desc';
                    }

                    sortAndRender();
                    updateSortIndicators();
                });
            });

            updateSortIndicators();
        }

        function updateSortIndicators() {
            document.querySelectorAll('th.sortable .sort-indicator').forEach(el => el.remove());

            const sortHeader = document.querySelector(`th[data-sort="${currentSort.column}"]`);
            if (sortHeader) {
                const indicator = document.createElement('span');
                indicator.className = 'sort-indicator';
                indicator.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                sortHeader.appendChild(indicator);
            }
        }

        function sortAndRender() {
            const sorted = [...allResults].sort((a, b) => {
                let aVal, bVal;

                switch (currentSort.column) {
                    case 'rank':
                        aVal = allResults.indexOf(a);
                        bVal = allResults.indexOf(b);
                        break;
                    case 'team':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        break;
                    case 'coach':
                        aVal = a.coach.toLowerCase();
                        bVal = b.coach.toLowerCase();
                        break;
                    case 'red':
                        aVal = a.redScore;
                        bVal = b.redScore;
                        break;
                    case 'red-per-game':
                        aVal = a.redPerGame;
                        bVal = b.redPerGame;
                        break;
                    case 'record':
                        aVal = a.actualWins;
                        bVal = b.actualWins;
                        break;
                    case 'games':
                        aVal = a.gamesPlayed;
                        bVal = b.gamesPlayed;
                        break;
                    default:
                        return 0;
                }

                if (typeof aVal === 'string') {
                    return currentSort.direction === 'asc' ? 
                        aVal.localeCompare(bVal) : 
                        bVal.localeCompare(aVal);
                }

                return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            });

            renderLeaderboard(sorted);
        }

        function filterBySearch(query) {
            const lowerQuery = query.toLowerCase();
            const filtered = allResults.filter(result => 
                result.name.toLowerCase().includes(lowerQuery) ||
                result.coach.toLowerCase().includes(lowerQuery) ||
                result.abbr.toLowerCase().includes(lowerQuery)
            );

            renderLeaderboard(filtered);
        }

        // Event Listeners
        searchBox.addEventListener('input', (e) => {
            filterBySearch(e.target.value);
        });

        helpBtn.addEventListener('click', () => {
            helpModal.style.display = 'block';
        });

        closeModalBtn.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // ‚îÄ‚îÄ Auto-refresh every 20 minutes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const REFRESH_INTERVAL_MS = 20 * 60 * 1000; // 20 minutes
        let refreshTimer = null;
        let countdownTimer = null;
        let nextRefreshAt = null;

        const nextRefreshLabel = document.getElementById('nextRefreshLabel');

        function startCountdown() {
            if (countdownTimer) clearInterval(countdownTimer);
            nextRefreshAt = Date.now() + REFRESH_INTERVAL_MS;
            countdownTimer = setInterval(() => {
                const remaining = Math.max(0, nextRefreshAt - Date.now());
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                nextRefreshLabel.textContent = `Auto-refresh in ${mins}:${String(secs).padStart(2,'0')}`;
            }, 1000);
        }

        function scheduleRefresh() {
            if (refreshTimer) clearTimeout(refreshTimer);
            startCountdown();
            refreshTimer = setTimeout(async () => {
                await initializeSystem();
                scheduleRefresh();
            }, REFRESH_INTERVAL_MS);
        }

        async function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.textContent = '‚ü≥ Refreshing‚Ä¶';
            btn.disabled = true;
            await initializeSystem();
            btn.textContent = '‚ü≥ Refresh';
            btn.disabled = false;
            scheduleRefresh();
        }

        // Initialize on load
        initializeSystem().then(() => scheduleRefresh());
    
</script>
</body>
</html>
/* RED Dashboard Stylesheet */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg-primary: #0a0e1a;
    --bg-secondary: #141929;
    --bg-card: #1a1f2e;
    --accent-gold: #C9A84C;
    --accent-gold-light: #e8d5b7;
    --text-primary: #e8edf5;
    --text-secondary: #a8b0c5;
    --border-color: #2a2f40;
    --success-color: #4ade80;
    --warning-color: #facc15;
    --danger-color: #f87171;
    --neutral-color: #6b7280;
    --scrollbar-track: #141929;
    --scrollbar-thumb: #3a3f50;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

/* Typography */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
}

/* Scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--scrollbar-track);
}

::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #4a4f60;
}

/* Container */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Header */
.header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
}

.header-content {
    flex: 1;
}

.title {
    display: flex;
    align-items: baseline;
    gap: 15px;
    margin-bottom: 8px;
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.title-red {
    color: var(--accent-gold);
    text-shadow: 0 0 20px rgba(201, 168, 76, 0.3);
}

.title-subtitle {
    font-size: 1rem;
    font-weight: 400;
    color: var(--text-secondary);
    letter-spacing: 1px;
}

.header-tagline {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 0;
}

.header-meta {
    display: flex;
    gap: 20px;
    align-items: center;
}

.update-info {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    padding: 8px 12px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 0.85rem;
}

.update-label {
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.update-time {
    color: var(--accent-gold);
    font-weight: 600;
    font-size: 0.95rem;
}

.info-button {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid var(--accent-gold);
    background: transparent;
    color: var(--accent-gold);
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-button:hover {
    background: var(--accent-gold);
    color: var(--bg-primary);
    transform: scale(1.1);
}

/* Disclaimer Banner */
.banner {
    padding: 12px 16px;
    background: rgba(250, 204, 21, 0.1);
    border: 1px solid var(--warning-color);
    border-radius: 6px;
    margin-bottom: 20px;
    color: var(--text-primary);
    font-size: 0.9rem;
    text-align: center;
}

/* Controls */
.controls {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.search-input {
    flex: 1;
    min-width: 250px;
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.search-input::placeholder {
    color: var(--text-secondary);
}

.search-input:focus {
    outline: none;
    border-color: var(--accent-gold);
    box-shadow: 0 0 0 3px rgba(201, 168, 76, 0.1);
}

/* Loading State */
.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    gap: 20px;
}

.loading.hidden {
    display: none;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid var(--bg-card);
    border-top-color: var(--accent-gold);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.loading p {
    color: var(--text-secondary);
}

/* Error State */
.error-state {
    padding: 30px;
    background: var(--bg-card);
    border: 1px solid var(--danger-color);
    border-radius: 8px;
    text-align: center;
    color: var(--danger-color);
}

.error-state.hidden {
    display: none;
}

.error-state h2 {
    margin-bottom: 10px;
}

.error-state button {
    margin-top: 15px;
    padding: 10px 20px;
    background: var(--danger-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.3s;
}

.error-state button:hover {
    opacity: 0.9;
}

/* Table Container */
.table-container {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: var(--shadow);
    background: var(--bg-card);
    border: 1px solid var(--border-color);
}

.table-container.hidden {
    display: none;
}

/* Table Styles */
.leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

.leaderboard-table thead {
    background: rgba(201, 168, 76, 0.05);
    border-bottom: 2px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 10;
}

.leaderboard-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--accent-gold);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    user-select: none;
}

.leaderboard-table th.sortable {
    cursor: pointer;
    transition: color 0.3s;
}

.leaderboard-table th.sortable:hover {
    color: var(--accent-gold-light);
}

.sort-indicator {
    display: inline-block;
    width: 10px;
    margin-left: 6px;
    opacity: 0;
    transition: opacity 0.3s;
}

.leaderboard-table th.sortable.asc .sort-indicator::after {
    content: '‚ñ≤';
    opacity: 1;
}

.leaderboard-table th.sortable.desc .sort-indicator::after {
    content: '‚ñº';
    opacity: 1;
}

.leaderboard-table tbody tr {
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.leaderboard-table tbody tr:hover {
    background: rgba(201, 168, 76, 0.05);
    transform: translateX(4px);
}

.leaderboard-table td {
    padding: 14px 12px;
    color: var(--text-primary);
}

/* Rank Column */
.rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: rgba(201, 168, 76, 0.2);
    border: 1px solid var(--accent-gold);
    border-radius: 50%;
    font-weight: 700;
    color: var(--accent-gold);
    font-size: 0.9rem;
}

/* Team Column */
.team-cell {
    display: flex;
    align-items: center;
    gap: 12px;
}

.team-logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    flex-shrink: 0;
    color: white;
}

.team-name {
    font-weight: 600;
    color: var(--text-primary);
}

/* RED Score Color Coding */
.red-score {
    font-weight: 700;
    font-size: 1.1rem;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
    min-width: 50px;
    text-align: center;
}

.red-score.positive {
    color: var(--success-color);
    background: rgba(74, 222, 128, 0.1);
}

.red-score.strong-positive {
    color: var(--success-color);
    background: rgba(74, 222, 128, 0.2);
    border: 1px solid var(--success-color);
}

.red-score.neutral {
    color: var(--neutral-color);
    background: rgba(107, 114, 128, 0.1);
}

.red-score.warning {
    color: var(--warning-color);
    background: rgba(250, 204, 21, 0.1);
}

.red-score.danger {
    color: var(--danger-color);
    background: rgba(248, 113, 113, 0.1);
}

/* Trend Indicators */
.trend-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.85rem;
}

.trend-badge.up {
    color: var(--success-color);
    background: rgba(74, 222, 128, 0.1);
}

.trend-badge.down {
    color: var(--danger-color);
    background: rgba(248, 113, 113, 0.1);
}

.trend-badge.neutral {
    color: var(--text-secondary);
    background: rgba(107, 114, 128, 0.1);
}

/* Chart Canvas */
.sparkline {
    width: 80px;
    height: 30px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: rgba(201, 168, 76, 0.03);
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-close {
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: var(--text-secondary);
    transition: color 0.3s;
}

.modal-close:hover {
    color: var(--accent-gold);
}

.modal-body {
    clear: both;
    margin-top: 20px;
}

.modal-body h3 {
    color: var(--accent-gold);
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.modal-body h4 {
    color: var(--text-primary);
    margin-top: 15px;
    margin-bottom: 8px;
    font-size: 0.95rem;
}

.modal-body p {
    color: var(--text-secondary);
    margin-bottom: 12px;
    line-height: 1.7;
}

.modal-body ul {
    margin-left: 20px;
    color: var(--text-secondary);
}

.modal-body li {
    margin-bottom: 8px;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .title {
        font-size: 1.8rem;
    }
    
    .leaderboard-table {
        font-size: 0.85rem;
    }
    
    .leaderboard-table th,
    .leaderboard-table td {
        padding: 12px 8px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .header {
        flex-direction: column;
        gap: 20px;
    }
    
    .title {
        font-size: 1.5rem;
    }
    
    .header-meta {
        width: 100%;
        justify-content: space-between;
    }
    
    .update-info {
        flex-direction: row;
        gap: 10px;
    }
    
    .search-input {
        min-width: 100%;
    }
    
    .leaderboard-table {
        font-size: 0.8rem;
    }
    
    .leaderboard-table th,
    .leaderboard-table td {
        padding: 10px 6px;
    }
    
    .team-logo {
        width: 32px;
        height: 32px;
        font-size: 0.75rem;
    }
    
    .sparkline {
        width: 60px;
        height: 25px;
    }
    
    .modal-content {
        padding: 20px;
    }
}

@media (max-width: 480px) {
    .title {
        flex-direction: column;
        gap: 5px;
        font-size: 1.2rem;
    }
    
    .title-subtitle {
        font-size: 0.8rem;
    }
    
    .leaderboard-table th,
    .leaderboard-table td {
        padding: 8px 4px;
        font-size: 0.7rem;
    }
    
    .team-cell {
        gap: 8px;
    }
    
    .team-logo {
        width: 28px;
        height: 28px;
        font-size: 0.65rem;
    }
    
    .rank-badge {
        width: 28px;
        height: 28px;
        font-size: 0.75rem;
    }
}
